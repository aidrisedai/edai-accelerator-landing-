<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Phase 2 Invitation â€“ EdAI Accelerator</title>
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Outfit', -apple-system, system-ui, sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 2rem 1rem;
    }
    .container {
      background: #ffffff;
      max-width: 780px;
      width: 100%;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.15);
      overflow: hidden;
    }
    .page-header {
      background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%);
      padding: 40px 32px;
      text-align: center;
      border-bottom: 4px solid #f97316;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.3rem 0.8rem;
      border-radius: 999px;
      background: rgba(249, 115, 22, 0.15);
      color: #fb923c;
      font-size: 0.72rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 1rem;
    }
    .page-header h1 { font-size: 1.6rem; color: white; margin-bottom: 0.35rem; font-weight: 800; }
    .page-header p { color: #bfdbfe; font-size: 0.95rem; font-weight: 500; }
    .body-content { padding: 2rem 2rem 2.5rem; }
    .greeting { font-size: 1rem; margin-bottom: 1rem; color: #0f172a; line-height: 1.6; }
    .info-box {
      background: #f8fafc;
      border-radius: 14px;
      padding: 1.25rem;
      margin: 1.25rem 0;
      border: 1px solid #e2e8f0;
    }
    .info-box h3 { font-size: 0.95rem; margin-bottom: 0.6rem; color: #0f172a; }
    .info-box p { font-size: 0.9rem; color: #475569; margin: 3px 0; }
    .info-box p strong { color: #0f172a; }
    .section-title { font-size: 1rem; font-weight: 700; color: #0f172a; margin: 1.5rem 0 0.75rem; }
    .curriculum-wrap {
      overflow-x: auto;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      margin: 0.75rem 0 1.5rem;
    }
    .curriculum-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    .curriculum-table thead tr {
      background: #f1f5f9;
      border-bottom: 2px solid #cbd5e1;
    }
    .curriculum-table th {
      padding: 10px;
      text-align: left;
      font-size: 0.72rem;
      text-transform: uppercase;
      color: #64748b;
      font-weight: 700;
    }
    .curriculum-table th:first-child { text-align: center; }
    .curriculum-table td {
      padding: 8px 10px;
      border-bottom: 1px solid #f1f5f9;
      color: #475569;
    }
    .curriculum-table td:first-child {
      font-weight: 700;
      color: #2563eb;
      text-align: center;
    }
    .curriculum-table td:nth-child(2) {
      font-weight: 600;
      color: #0f172a;
    }
    .response-section {
      background: #f0fdf4;
      border: 2px solid #86efac;
      border-radius: 14px;
      padding: 1.5rem;
      margin-top: 1.5rem;
    }
    .response-section h3 { font-size: 1rem; color: #166534; margin-bottom: 0.75rem; }
    .notes-label { display: block; font-size: 0.85rem; font-weight: 600; color: #475569; margin-bottom: 0.4rem; }
    .notes-textarea {
      width: 100%;
      padding: 0.65rem;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-family: inherit;
      font-size: 0.9rem;
      min-height: 80px;
      resize: vertical;
      margin-bottom: 1rem;
    }
    .notes-textarea:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15); }
    .btn-row { display: flex; gap: 0.75rem; flex-wrap: wrap; }
    .btn-accept {
      flex: 1;
      min-width: 200px;
      padding: 0.9rem 1.5rem;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #16a34a, #22c55e);
      color: white;
      font-weight: 700;
      font-size: 0.95rem;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .btn-accept:hover { transform: translateY(-1px); box-shadow: 0 10px 25px rgba(22, 163, 74, 0.3); }
    .btn-accept:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-decline {
      flex: 1;
      min-width: 200px;
      padding: 0.9rem 1.5rem;
      border-radius: 999px;
      border: 2px solid #d1d5db;
      background: white;
      color: #64748b;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-decline:hover { border-color: #ef4444; color: #ef4444; }
    .btn-decline:disabled { opacity: 0.6; cursor: not-allowed; }
    .error {
      background: #fee2e2;
      border: 1px solid #fecaca;
      color: #b91c1c;
      padding: 1rem;
      border-radius: 12px;
      font-size: 0.9rem;
      margin: 1rem 0;
    }
    .success-screen { text-align: center; padding: 2rem 1rem; }
    .success-screen .icon { font-size: 3rem; margin-bottom: 0.75rem; }
    .success-screen h2 { font-size: 1.4rem; margin-bottom: 0.5rem; }
    .success-screen p { color: #475569; font-size: 0.95rem; margin-bottom: 0.25rem; }
    .loading { text-align: center; color: #64748b; font-size: 0.95rem; padding: 3rem 1rem; }
    .already-responded { text-align: center; padding: 2rem 1rem; }
    .already-responded h2 { font-size: 1.3rem; margin-bottom: 0.5rem; }
    .contact-line { font-size: 0.85rem; color: #64748b; margin-top: 1.25rem; }
    .contact-line a { color: #2563eb; font-weight: 500; }
    @media (max-width: 640px) {
      body { padding: 1rem 0.75rem; }
      .body-content { padding: 1.5rem 1.25rem; }
      .page-header { padding: 28px 20px; }
      .page-header h1 { font-size: 1.3rem; }
      .btn-row { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="page-header">
      <div class="pill">Phase 2 Â· Accelerator</div>
      <h1>ðŸš€ Phase 2 Invitation</h1>
      <p>12 Weeks of Real-World Venture Building</p>
    </div>
    <div class="body-content" id="mainContent">
      <div class="loading">Loading your invitation details...</div>
    </div>
  </div>

  <script>
    const mainEl = document.getElementById('mainContent');
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    const CURRICULUM = [
      { week: 21, theme: 'Entry, Expectations & Reality', activity: 'Confirm teams, sign working agreements, set honest goals', expert: 'EdAI leadership + returning founder' },
      { week: 22, theme: 'Problem Discovery & Customer Access', activity: 'Interview 10+ potential users, document pain points', expert: 'Founder / customer development expert' },
      { week: 23, theme: 'Problem Lock-In & Team Formation', activity: 'Choose one problem, define ownership & decision rights', expert: 'Operator / leadership coach' },
      { week: 24, theme: 'Business Models & Product Roadmap', activity: 'Understand business structures, define minimal MVP', expert: 'Legal expert / product manager' },
      { week: 25, theme: 'Budget, Build & Launch Sprint', activity: 'Create spend plan, build core product with real constraints', expert: 'Finance / engineering mentor' },
      { week: 26, theme: 'User Testing & Sales', activity: 'Run 15+ user tests, attempt first sales conversations', expert: 'UX researcher / sales professional' },
      { week: 27, theme: 'Pivot or Persevere Decision', activity: 'Use data to decide: continue, pivot, or stop', expert: 'Product manager + mentor panel' },
      { week: 28, theme: 'Build Sprint 2 & GTM Strategy', activity: 'Iterate on feedback, choose distribution channels', expert: 'Engineering mentor / growth expert' },
      { week: 29, theme: 'Operations, Metrics & Legal', activity: 'Set up workflows, tracking, and address legal/ethics', expert: 'Operator / legal advisor' },
      { week: 30, theme: 'Build Sprint 3 & Capital Options', activity: "Scale what works, explore funding if traction warrants", expert: 'Engineering mentor / investor' },
      { week: 31, theme: 'Demo Preparation & Story', activity: "Present the truth: what worked, what didn't, what's next", expert: 'Pitch coach' },
      { week: 32, theme: 'Demo Day & Real Decision Point', activity: 'Present to community, commit to continue or sunset', expert: 'Community + parents + advisors' }
    ];

    if (!token) {
      mainEl.innerHTML = '<div class="error">Invalid invitation link. Please check your email and try again.</div>';
    } else {
      loadInvitation();
    }

    async function loadInvitation() {
      try {
        const res = await fetch(`/api/get-phase2-invite?token=${encodeURIComponent(token)}`);
        const data = await res.json();

        if (!data.success) {
          mainEl.innerHTML = `<div class="error">${escapeHtml(data.error || 'Unable to load your invitation.')}</div>`;
          return;
        }

        const inv = data.invitation;

        if (inv.status === 'accepted') {
          renderAlreadyResponded(inv, true);
        } else if (inv.status === 'declined') {
          renderAlreadyResponded(inv, false);
        } else {
          renderInvitation(inv);
        }
      } catch (err) {
        console.error(err);
        mainEl.innerHTML = '<div class="error">Something went wrong loading your invitation. Please refresh or contact us.</div>';
      }
    }

    function renderAlreadyResponded(inv, accepted) {
      const respondedAt = inv.responded_at ? new Date(inv.responded_at).toLocaleString() : '';
      mainEl.innerHTML = `
        <div class="already-responded">
          <div style="font-size:3rem;margin-bottom:0.75rem;">${accepted ? 'âœ…' : 'ðŸ“‹'}</div>
          <h2>${accepted ? 'You\'re In!' : 'Response Recorded'}</h2>
          <p>${accepted
            ? `<strong>${escapeHtml(inv.student_name)}</strong> is confirmed for Phase 2. We'll be in touch with next steps, in shaa Allah.`
            : `We've recorded that <strong>${escapeHtml(inv.student_name)}</strong> won't be joining Phase 2 this time.`
          }</p>
          ${respondedAt ? `<p style="font-size:0.85rem;color:#9ca3af;margin-top:0.75rem;">Responded on ${respondedAt}</p>` : ''}
          <p class="contact-line">Questions? Contact <a href="mailto:aidris@edai.fun">aidris@edai.fun</a> or <a href="tel:+15153570454">515-357-0454</a></p>
        </div>
      `;
    }

    function renderInvitation(inv) {
      const currRows = CURRICULUM.map(w => `
        <tr>
          <td>${w.week}</td>
          <td>${w.theme}</td>
          <td>${w.activity}</td>
          <td>${w.expert}</td>
        </tr>
      `).join('');

      mainEl.innerHTML = `
        <p class="greeting"><strong>Assalamu Alaikum ${escapeHtml(inv.parent_name)},</strong></p>
        <p class="greeting">Alhamdulillah, <strong>${escapeHtml(inv.student_name)}</strong> has completed Phase 1 of the EdAI Accelerator! We are excited to invite them to continue their journey in <strong>Phase 2</strong> â€” a 12-week deep dive where students go from prototype to real venture.</p>

        <div class="info-box">
          <h3>ðŸ“‹ Phase 2 at a Glance</h3>
          <p><strong>Duration:</strong> 12 weeks (Weeks 21â€“32)</p>
          <p><strong>Schedule:</strong> Saturdays, 9 AM â€“ 12:30 PM</p>
          <p><strong>Focus:</strong> Customer discovery, team formation, real builds, sales, Demo Day</p>
          <p><strong>Expert Access:</strong> Weekly sessions with founders, engineers, lawyers, investors & more</p>
        </div>

        <h3 class="section-title">ðŸ“š Full Curriculum (Weeks 21â€“32)</h3>
        <div class="curriculum-wrap">
          <table class="curriculum-table">
            <thead><tr>
              <th>Week</th>
              <th>Theme</th>
              <th>What Students Do</th>
              <th>Expert / Support</th>
            </tr></thead>
            <tbody>${currRows}</tbody>
          </table>
        </div>

        <div class="response-section">
          <h3>âœ… Will ${escapeHtml(inv.student_name)} be joining Phase 2?</h3>
          <label class="notes-label">Any notes or questions for us? (Optional)</label>
          <textarea class="notes-textarea" id="parentNotes" placeholder="e.g. scheduling concerns, questions about the curriculum..."></textarea>
          <div id="responseError"></div>
          <div class="btn-row">
            <button class="btn-accept" id="btnAccept" onclick="respond('accepted')">âœ… Yes, We Want to Join Phase 2</button>
            <button class="btn-decline" id="btnDecline" onclick="respond('declined')">No, Not at This Time</button>
          </div>
        </div>

        <p class="contact-line">Questions? Contact <a href="mailto:aidris@edai.fun">aidris@edai.fun</a> or call/text <a href="tel:+15153570454">515-357-0454</a></p>
      `;
    }

    async function respond(response) {
      const btnAccept = document.getElementById('btnAccept');
      const btnDecline = document.getElementById('btnDecline');
      const errEl = document.getElementById('responseError');
      const notes = document.getElementById('parentNotes').value.trim();

      if (response === 'declined') {
        if (!confirm('Are you sure you want to decline the Phase 2 invitation?')) return;
      }

      btnAccept.disabled = true;
      btnDecline.disabled = true;
      btnAccept.textContent = 'Submitting...';
      errEl.innerHTML = '';

      try {
        const res = await fetch('/api/respond-phase2-invite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token, response, parentNotes: notes || null })
        });

        const data = await res.json();

        if (data.success) {
          if (response === 'accepted') {
            mainEl.innerHTML = `
              <div class="success-screen">
                <div class="icon">ðŸŽ‰</div>
                <h2>Jazakallahu Khairan!</h2>
                <p>We're thrilled to have your child continue in Phase 2.</p>
                <p>We'll be in touch with onboarding details and next steps soon, in shaa Allah.</p>
                <p class="contact-line" style="margin-top:1.5rem;">Questions? <a href="mailto:aidris@edai.fun">aidris@edai.fun</a> Â· <a href="tel:+15153570454">515-357-0454</a></p>
              </div>
            `;
          } else {
            mainEl.innerHTML = `
              <div class="success-screen">
                <div class="icon">ðŸ“‹</div>
                <h2>Response Recorded</h2>
                <p>Thank you for letting us know. We hope to see your child in a future cohort, in shaa Allah.</p>
                <p class="contact-line" style="margin-top:1.5rem;">Changed your mind? Contact <a href="mailto:aidris@edai.fun">aidris@edai.fun</a></p>
              </div>
            `;
          }
        } else {
          errEl.innerHTML = `<div class="error" style="margin-bottom:1rem;">${escapeHtml(data.error || 'Something went wrong.')}</div>`;
          btnAccept.disabled = false;
          btnDecline.disabled = false;
          btnAccept.textContent = 'âœ… Yes, We Want to Join Phase 2';
        }
      } catch (err) {
        console.error(err);
        errEl.innerHTML = '<div class="error" style="margin-bottom:1rem;">Network error. Please check your connection and try again.</div>';
        btnAccept.disabled = false;
        btnDecline.disabled = false;
        btnAccept.textContent = 'âœ… Yes, We Want to Join Phase 2';
      }
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }
  </script>
</body>
</html>
