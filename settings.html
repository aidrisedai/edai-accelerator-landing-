<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - EdAI Accelerator Admin</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f3f4f6;
            color: #1f2937;
            line-height: 1.6;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            color: white;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .dashboard-header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dashboard-header h1 {
            font-size: 1.75rem;
        }
        
        .btn-back {
            padding: 0.5rem 1.5rem;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-back:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .settings-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }
        
        .settings-section h2 {
            color: #2563eb;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }
        
        .form-group small {
            display: block;
            margin-top: 0.25rem;
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2563eb;
        }
        
        .form-group textarea {
            min-height: 200px;
            resize: vertical;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        
        .template-vars {
            background: #f0f9ff;
            border: 2px solid #3b82f6;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 0.5rem;
        }
        
        .template-vars h4 {
            color: #1e40af;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        
        .template-vars code {
            display: inline-block;
            background: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin: 0.25rem;
            font-size: 0.75rem;
            color: #2563eb;
        }
        
        .btn-save {
            padding: 0.875rem 2rem;
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }
        
        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }
        
        .btn-test {
            padding: 0.875rem 2rem;
            background: linear-gradient(135deg, #f97316, #fb923c);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            margin-left: 1rem;
        }
        
        .btn-test:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(249, 115, 22, 0.3);
        }
        
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: none;
        }
        
        .alert.success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
        }
        
        .alert.error {
            background: #fee2e2;
            color: #dc2626;
            border: 2px solid #ef4444;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }
        
        .info-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 8px;
        }
        
        .info-box strong {
            color: #92400e;
        }
        
        .btn-preview {
            padding: 0.5rem 1rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            margin-left: 0.5rem;
        }
        
        .btn-preview:hover {
            background: #2563eb;
        }
        
        .template-preview {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .template-preview.active {
            display: block;
        }
        
        .template-preview pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            margin: 0;
        }
        
        .btn-copy-template {
            padding: 0.5rem 1rem;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        
        .btn-preview-email {
            padding: 0.5rem 1rem;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            margin-left: 0.5rem;
        }
        
        .btn-preview-email:hover {
            background: #7c3aed;
        }
        
        .btn-ai-improve {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #ec4899, #f472b6);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            margin-left: 0.5rem;
        }
        
        .btn-ai-improve:hover {
            background: linear-gradient(135deg, #db2777, #ec4899);
        }
        
        .email-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .email-preview-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .email-preview-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .email-preview-header {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            color: white;
            padding: 1.5rem;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .email-preview-body {
            padding: 2rem;
            background: #f9fafb;
        }
        
        .email-preview-iframe {
            width: 100%;
            min-height: 500px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
        }
        
        .ai-prompt-section {
            background: #fdf4ff;
            border: 2px solid #e879f9;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }
        
        .ai-prompt-section.active {
            display: block;
        }
        
        .ai-prompt-section textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.75rem;
            border: 2px solid #e879f9;
            border-radius: 6px;
            font-family: 'Outfit', sans-serif;
            margin-top: 0.5rem;
        }
        
        .btn-close-modal {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-close-modal:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="dashboard-header-content">
            <h1>‚öôÔ∏è Settings</h1>
            <a href="/admin" class="btn-back">‚Üê Back to Dashboard</a>
        </div>
    </div>
    
    <div class="container">
        <div id="alertMessage" class="alert"></div>
        
        <div id="migrationNotice" class="info-box" style="display: none; background: #fee2e2; border-left-color: #ef4444;">
            <strong>‚ö†Ô∏è Database Setup Required:</strong> The settings table doesn't exist yet. 
            <button onclick="runMigration()" style="margin-left: 1rem; padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Run Migration Now</button>
        </div>
        
        <div class="settings-section">
            <h2>üîë API Configuration</h2>
            
            <div class="info-box">
                <strong>‚ö†Ô∏è Important:</strong> Your Resend API key is required to send emails. Get your key at <a href="https://resend.com/api-keys" target="_blank" style="color: #2563eb;">resend.com/api-keys</a>
            </div>
            
            <div class="form-group">
                <label for="resendApiKey">Resend API Key</label>
                <input type="password" id="resendApiKey" placeholder="re_xxxxxxxxxxxxx">
                <small>Your API key will be stored securely in the database. Get it at <a href="https://resend.com/api-keys" target="_blank" style="color: #2563eb;">resend.com/api-keys</a></small>
            </div>
            
            <div class="form-group">
                <label for="openaiApiKey">OpenAI API Key (for AI email improvements)</label>
                <input type="password" id="openaiApiKey" placeholder="sk-xxxxxxxxxxxxx">
                <small>Required for AI email improvements. Get it at <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #2563eb;">platform.openai.com/api-keys</a></small>
            </div>
            
            <div class="form-group">
                <label for="emailFromAddress">Email From Address</label>
                <input type="text" id="emailFromAddress" placeholder="EdAI Accelerator <noreply@edaiaccelerator.com>">
                <small>Format: Name &lt;email@domain.com&gt;</small>
            </div>
        </div>
        
        <div class="settings-section">
            <h2>üìß Welcome Email (Regular Applications)</h2>
            
            <div class="form-group">
                <label for="welcomeSubject">Email Subject</label>
                <input type="text" id="welcomeSubject" placeholder="Application Received - Thank You! | EdAI Accelerator">
            </div>
            
            <div class="form-group">
                <label for="welcomeBody">
                    Email Body (HTML)
                    <button type="button" class="btn-preview" onclick="toggleTemplate('welcomeTemplate')">üëÅÔ∏è View Default Template</button>
                    <button type="button" class="btn-preview-email" onclick="previewEmail('welcome')">üì¨ Preview Email</button>
                    <button type="button" class="btn-ai-improve" onclick="toggleAIPrompt('welcomeAI')">‚ú® AI Improve</button>
                </label>
                <textarea id="welcomeBody" placeholder="Leave empty to use default template..."></textarea>
                <small>Leave empty to use the default professional template. Or paste your custom HTML.</small>
                
                <div id="welcomeAI" class="ai-prompt-section">
                    <h4 style="margin: 0 0 0.5rem 0; color: #a855f7;">‚ú® AI Email Improvement</h4>
                    <textarea id="welcomeAIPrompt" placeholder="Example: Make the email more welcoming and add a section about program benefits"></textarea>
                    <button class="btn-ai-improve" onclick="improveEmailWithAI('welcome')" style="margin-top: 0.5rem;">‚ú® Improve with AI</button>
                </div>
                
                <div id="welcomeTemplate" class="template-preview">
                    <button class="btn-copy-template" onclick="copyTemplate('welcome')">üìã Copy Template to Editor</button>
                    <pre id="welcomeTemplateCode"></pre>
                </div>
                
                <div class="template-vars">
                    <h4>Available Variables:</h4>
                    <code>{{parent_name}}</code>
                    <code>{{children_list}}</code>
                    <code>{{total_children}}</code>
                    <code>{{application_id}}</code>
                    <code>{{submitted_date}}</code>
                    <code>{{parent_email}}</code>
                </div>
            </div>
        </div>
        
        <div class="settings-section">
            <h2>‚è∞ Waitlist Email (2026 Applications)</h2>
            
            <div class="form-group">
                <label for="waitlistSubject">Email Subject</label>
                <input type="text" id="waitlistSubject" placeholder="Application Received - 2026 Waitlist | EdAI Accelerator">
            </div>
            
            <div class="form-group">
                <label for="waitlistBody">
                    Email Body (HTML)
                    <button type="button" class="btn-preview" onclick="toggleTemplate('waitlistTemplate')">üëÅÔ∏è View Default Template</button>
                    <button type="button" class="btn-preview-email" onclick="previewEmail('waitlist')">üì¨ Preview Email</button>
                    <button type="button" class="btn-ai-improve" onclick="toggleAIPrompt('waitlistAI')">‚ú® AI Improve</button>
                </label>
                <textarea id="waitlistBody" placeholder="Leave empty to use default template..."></textarea>
                <small>Leave empty to use the default professional template. Or paste your custom HTML.</small>
                
                <div id="waitlistAI" class="ai-prompt-section">
                    <h4 style="margin: 0 0 0.5rem 0; color: #a855f7;">‚ú® AI Email Improvement</h4>
                    <textarea id="waitlistAIPrompt" placeholder="Example: Make it sound more encouraging for waitlist parents"></textarea>
                    <button class="btn-ai-improve" onclick="improveEmailWithAI('waitlist')" style="margin-top: 0.5rem;">‚ú® Improve with AI</button>
                </div>
                
                <div id="waitlistTemplate" class="template-preview">
                    <button class="btn-copy-template" onclick="copyTemplate('waitlist')">üìã Copy Template to Editor</button>
                    <pre id="waitlistTemplateCode"></pre>
                </div>
                
                <div class="template-vars">
                    <h4>Available Variables:</h4>
                    <code>{{parent_name}}</code>
                    <code>{{children_list}}</code>
                    <code>{{total_children}}</code>
                    <code>{{application_id}}</code>
                    <code>{{submitted_date}}</code>
                    <code>{{parent_email}}</code>
                </div>
            </div>
        </div>
        
        <div class="settings-section">
            <h2>üìÖ Interview Invitation Email</h2>
            
            <div class="form-group">
                <label for="interviewInviteSubject">Email Subject</label>
                <input type="text" id="interviewInviteSubject" placeholder="Interview Invitation for {{student_name}} - EdAI Accelerator">
            </div>
            
            <div class="form-group">
                <label for="interviewInviteBody">Email Body (HTML)</label>
                <textarea id="interviewInviteBody" placeholder="Leave empty to use default template..."></textarea>
                <small>Leave empty to use the default template. Or paste your custom HTML.</small>
                
                <div class="template-vars">
                    <h4>Available Variables:</h4>
                    <code>{{parent_name}}</code>
                    <code>{{student_name}}</code>
                    <code>{{proposed_times_list}}</code>
                    <code>{{confirmation_link}}</code>
                    <code>{{custom_message}}</code>
                </div>
            </div>
        </div>
        
        <div class="settings-section">
            <h2>‚úÖ Interview Confirmed Email</h2>
            
            <div class="form-group">
                <label for="interviewConfirmedSubject">Email Subject</label>
                <input type="text" id="interviewConfirmedSubject" placeholder="Interview Confirmed for {{student_name}} - EdAI Accelerator">
            </div>
            
            <div class="form-group">
                <label for="interviewConfirmedBody">Email Body (HTML)</label>
                <textarea id="interviewConfirmedBody" placeholder="Leave empty to use default template..."></textarea>
                <small>Leave empty to use the default template. Or paste your custom HTML.</small>
                
                <div class="template-vars">
                    <h4>Available Variables:</h4>
                    <code>{{parent_name}}</code>
                    <code>{{student_name}}</code>
                    <code>{{confirmed_date_time}}</code>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 2rem; display: flex; justify-content: space-between; align-items: center;">
            <button class="btn-save" onclick="saveSettings()">üíæ Save All Settings</button>
        </div>
    </div>
    
    <!-- Email Preview Modal -->
    <div id="emailPreviewModal" class="email-preview-modal">
        <div class="email-preview-content">
            <div class="email-preview-header">
                <h2 style="margin: 0;">üì¨ Email Preview</h2>
                <button class="btn-close-modal" onclick="closePreviewModal()">&times;</button>
            </div>
            <div class="email-preview-body">
                <iframe id="emailPreviewFrame" class="email-preview-iframe"></iframe>
            </div>
        </div>
    </div>
    
    <!-- AI Improvement Preview Modal -->
    <div id="aiPreviewModal" class="email-preview-modal">
        <div class="email-preview-content">
            <div class="email-preview-header" style="background: linear-gradient(135deg, #ec4899, #f472b6);">
                <h2 style="margin: 0;">‚ú® AI Improved Email Preview</h2>
                <button class="btn-close-modal" onclick="closeAIPreviewModal()">&times;</button>
            </div>
            <div class="email-preview-body">
                <div style="background: #fdf4ff; border: 2px solid #e879f9; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="margin: 0; color: #a855f7; font-weight: 600;">‚ÑπÔ∏è Review the AI-improved email below. Click "Accept Changes" to apply it to your template, or "Reject" to discard.</p>
                </div>
                <iframe id="aiPreviewFrame" class="email-preview-iframe"></iframe>
                <div style="display: flex; gap: 1rem; margin-top: 1rem; justify-content: center;">
                    <button onclick="acceptAIImprovement()" style="padding: 0.875rem 2rem; background: linear-gradient(135deg, #10b981, #34d399); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 1rem;">‚úì Accept Changes</button>
                    <button onclick="rejectAIImprovement()" style="padding: 0.875rem 2rem; background: linear-gradient(135deg, #ef4444, #f87171); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 1rem;">‚úó Reject</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Check authentication
        if (sessionStorage.getItem('adminAuth') !== 'true') {
            window.location.href = '/admin';
        }
        
        // Load settings on page load
        loadSettings();
        
        async function loadSettings() {
            console.log('=== LOAD SETTINGS CALLED ===');
            try {
                const response = await fetch('/api/get-settings');
                console.log('Load settings response status:', response.status);
                
                const data = await response.json();
                console.log('Load settings response data:', data);
                
                if (data.success) {
                    const s = data.settings;
                    console.log('Settings loaded from database:');
                    console.log('- resend_api_key length:', s.resend_api_key?.length || 0);
                    console.log('- openai_api_key length:', s.openai_api_key?.length || 0);
                    console.log('- openai_api_key prefix:', s.openai_api_key?.substring(0, 7) || 'none');
                    console.log('- email_from_address:', s.email_from_address);
                    
                    document.getElementById('resendApiKey').value = s.resend_api_key || '';
                    document.getElementById('openaiApiKey').value = s.openai_api_key || '';
                    document.getElementById('emailFromAddress').value = s.email_from_address || '';
                    document.getElementById('welcomeSubject').value = s.welcome_email_subject || '';
                    document.getElementById('welcomeBody').value = s.welcome_email_body || '';
                    document.getElementById('waitlistSubject').value = s.waitlist_email_subject || '';
                    document.getElementById('waitlistBody').value = s.waitlist_email_body || '';
                    document.getElementById('interviewInviteSubject').value = s.interview_invite_subject || '';
                    document.getElementById('interviewInviteBody').value = s.interview_invite_body || '';
                    document.getElementById('interviewConfirmedSubject').value = s.interview_confirmed_subject || '';
                    document.getElementById('interviewConfirmedBody').value = s.interview_confirmed_body || '';
                    
                    console.log('‚úì Settings loaded into form fields');
                } else {
                    console.error('Failed to load settings:', data.error);
                    // Settings table might not exist
                    document.getElementById('migrationNotice').style.display = 'block';
                    showAlert('Settings table not found. Please run migration.', 'error');
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                console.error('Error stack:', error.stack);
                document.getElementById('migrationNotice').style.display = 'block';
                showAlert('Failed to load settings. Database may need migration.', 'error');
            }
        }
        
        async function runMigration() {
            try {
                showAlert('Running database migration...', 'success');
                const response = await fetch('/api/migrate-database', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showAlert('‚úì Migration completed! Reloading settings...', 'success');
                    document.getElementById('migrationNotice').style.display = 'none';
                    setTimeout(() => {
                        loadSettings();
                    }, 1000);
                } else {
                    showAlert('Migration failed: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Migration error:', error);
                showAlert('Failed to run migration: ' + error.message, 'error');
            }
        }
        
        async function saveSettings() {
            console.log('=== SAVE SETTINGS CALLED ===');
            showAlert('Saving settings...', 'success');
            
            const settings = {
                resend_api_key: document.getElementById('resendApiKey').value,
                openai_api_key: document.getElementById('openaiApiKey').value,
                email_from_address: document.getElementById('emailFromAddress').value,
                welcome_email_subject: document.getElementById('welcomeSubject').value,
                welcome_email_body: document.getElementById('welcomeBody').value,
                waitlist_email_subject: document.getElementById('waitlistSubject').value,
                waitlist_email_body: document.getElementById('waitlistBody').value,
                interview_invite_subject: document.getElementById('interviewInviteSubject').value,
                interview_invite_body: document.getElementById('interviewInviteBody').value,
                interview_confirmed_subject: document.getElementById('interviewConfirmedSubject').value,
                interview_confirmed_body: document.getElementById('interviewConfirmedBody').value
            };
            
            console.log('Settings object created:');
            console.log('- resend_api_key length:', settings.resend_api_key?.length || 0);
            console.log('- openai_api_key length:', settings.openai_api_key?.length || 0);
            console.log('- openai_api_key prefix:', settings.openai_api_key?.substring(0, 7) || 'none');
            console.log('- email_from_address:', settings.email_from_address);
            console.log('Full settings object:', settings);
            
            try {
                const requestBody = { settings };
                console.log('Sending POST to /api/update-settings');
                console.log('Request body:', requestBody);
                
                const response = await fetch('/api/update-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('Response received:');
                console.log('- Status:', response.status);
                console.log('- Status Text:', response.statusText);
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    showAlert('‚úì Settings saved successfully!', 'success');
                    
                    // Reload settings to verify they were saved
                    console.log('Reloading settings to verify save...');
                    setTimeout(async () => {
                        await loadSettings();
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 500);
                } else {
                    console.error('Save failed:', data.error);
                    showAlert('Error: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                console.error('Error stack:', error.stack);
                showAlert('Failed to save settings: ' + error.message, 'error');
            }
        }
        
        function showAlert(message, type) {
            const alert = document.getElementById('alertMessage');
            alert.textContent = message;
            alert.className = `alert ${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
        
        function toggleTemplate(templateId) {
            const template = document.getElementById(templateId);
            template.classList.toggle('active');
            
            // Load template content if not already loaded
            if (template.classList.contains('active') && !template.dataset.loaded) {
                loadTemplateContent(templateId);
                template.dataset.loaded = 'true';
            }
        }
        
        function loadTemplateContent(templateId) {
            const templates = {
                welcomeTemplate: getWelcomeTemplate(false),
                waitlistTemplate: getWelcomeTemplate(true)
            };
            
            const codeElement = document.getElementById(templateId + 'Code');
            if (codeElement && templates[templateId]) {
                codeElement.textContent = templates[templateId];
            }
        }
        
        function copyTemplate(type) {
            let template;
            if (type === 'welcome') {
                template = getWelcomeTemplate(false);
                document.getElementById('welcomeBody').value = template;
                showAlert('‚úì Welcome template copied to editor!', 'success');
            } else if (type === 'waitlist') {
                template = getWelcomeTemplate(true);
                document.getElementById('waitlistBody').value = template;
                showAlert('‚úì Waitlist template copied to editor!', 'success');
            }
        }
        
        function getWelcomeTemplate(isWaitlist) {
            return `<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            color: white;
            padding: 30px;
            border-radius: 12px 12px 0 0;
            text-align: center;
        }
        .content {
            background: #f9fafb;
            padding: 30px;
            border-radius: 0 0 12px 12px;
        }
        .info-box {
            background: white;
            border-left: 4px solid #2563eb;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .child-name {
            color: #2563eb;
            font-weight: bold;
            font-size: 18px;
        }
        .next-steps {
            background: #eff6ff;
            border: 2px solid #3b82f6;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .next-steps h3 {
            color: #1e40af;
            margin-top: 0;
        }
        .next-steps ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .next-steps li {
            margin: 8px 0;
        }
        .footer {
            text-align: center;
            padding: 20px;
            color: #6b7280;
            font-size: 14px;
        }
        .badge {
            display: inline-block;
            padding: 6px 12px;
            background: #fbbf24;
            color: #92400e;
            border-radius: 6px;
            font-weight: bold;
            font-size: 14px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéì EdAI Accelerator</h1>
        <p style="margin: 0; font-size: 18px;">${isWaitlist ? '2026 Waitlist Application Received' : 'Application Received!'}</p>
    </div>
    
    <div class="content">
        <p style="font-size: 16px;"><strong>Assalamu Alaikum {{parent_name}},</strong></p>
        
        <p>Jazakallahu Khairan for your interest in the EdAI Accelerator program! We have successfully received your application for:</p>
        
        <div class="info-box">
            <p class="child-name">{{children_list}}</p>
        </div>
        
        ${isWaitlist ? `
        <div class="badge">‚è∞ 2026 Waitlist</div>
        <p>Since the December 2025 cohort has closed, your application has been added to our 2026 waitlist. We will contact you early next year with program details, dates, and pricing, in shaa Allah.</p>
        ` : `
        <div class="next-steps">
            <h3>üìã What Happens Next?</h3>
            <ul>
                <li><strong>Review Period:</strong> Our team will carefully review the application within 3-5 business days</li>
                <li><strong>Interview Invitation:</strong> If selected, you'll receive an email with available interview times</li>
                <li><strong>Program Details:</strong> We'll share more information about the curriculum, schedule, and next steps</li>
            </ul>
        </div>
        `}
        
        <div class="info-box">
            <p><strong>üìß Application ID:</strong> #{{application_id}}</p>
            <p><strong>üìÖ Submitted:</strong> {{submitted_date}}</p>
        </div>
        
        <p>If you have any questions in the meantime, please don't hesitate to reach out to us at <a href="mailto:contact@edaiaccelerator.com" style="color: #2563eb;">contact@edaiaccelerator.com</a></p>
        
        <p style="margin-top: 30px;">Jazakallahu Khairan,<br>
        <strong>The EdAI Accelerator Team</strong></p>
    </div>
    
    <div class="footer">
        <p>¬© 2025 EdAI Accelerator | Empowering Muslim youth through product innovation</p>
        <p style="font-size: 12px; color: #9ca3af;">This email was sent to {{parent_email}} because you submitted an application to EdAI Accelerator.</p>
    </div>
</body>
</html>`;
        }
        
        function toggleAIPrompt(promptId) {
            console.log('toggleAIPrompt called with:', promptId);
            const section = document.getElementById(promptId);
            if (!section) {
                console.error('Section not found:', promptId);
                return;
            }
            section.classList.toggle('active');
        }
        
        function previewEmail(type) {
            console.log('previewEmail called with type:', type);
            let html;
            const welcomeBody = document.getElementById('welcomeBody');
            const waitlistBody = document.getElementById('waitlistBody');
            
            if (!welcomeBody || !waitlistBody) {
                console.error('Email body textareas not found');
                showAlert('Error: Email fields not found', 'error');
                return;
            }
            
            if (type === 'welcome') {
                html = welcomeBody.value || getWelcomeTemplate(false);
            } else if (type === 'waitlist') {
                html = waitlistBody.value || getWelcomeTemplate(true);
            }
            
            console.log('HTML length:', html.length);
            
            // Replace variables with sample data
            const sampleData = {
                parent_name: 'Ahmed',
                children_list: 'Sara (8th Grade), Ibrahim (10th Grade)',
                total_children: 2,
                application_id: 12345,
                submitted_date: 'Tuesday, December 24, 2025',
                parent_email: 'parent@example.com'
            };
            
            Object.keys(sampleData).forEach(key => {
                html = html.replace(new RegExp(`{{${key}}}`, 'g'), sampleData[key]);
            });
            
            // Show in modal
            const modal = document.getElementById('emailPreviewModal');
            const iframe = document.getElementById('emailPreviewFrame');
            
            modal.classList.add('active');
            iframe.srcdoc = html;
        }
        
        function closePreviewModal() {
            document.getElementById('emailPreviewModal').classList.remove('active');
        }
        
        function closeAIPreviewModal() {
            document.getElementById('aiPreviewModal').classList.remove('active');
            // Clear the temp data
            window.aiTempData = null;
        }
        
        function acceptAIImprovement() {
            if (!window.aiTempData) {
                console.error('No AI improvement data to accept');
                return;
            }
            
            console.log('Accepting AI improvement for type:', window.aiTempData.type);
            const emailTextarea = document.getElementById(window.aiTempData.type + 'Body');
            emailTextarea.value = window.aiTempData.improvedTemplate;
            
            closeAIPreviewModal();
            showAlert('‚úì AI improvements applied! Don\'t forget to save your settings.', 'success');
            
            // Clear the AI prompt section
            const promptTextarea = document.getElementById(window.aiTempData.type + 'AIPrompt');
            if (promptTextarea) {
                promptTextarea.value = '';
            }
            document.getElementById(window.aiTempData.type + 'AI').classList.remove('active');
            
            window.aiTempData = null;
        }
        
        function rejectAIImprovement() {
            console.log('Rejecting AI improvement');
            closeAIPreviewModal();
            showAlert('AI improvements discarded.', 'success');
            window.aiTempData = null;
        }
        
        async function improveEmailWithAI(type) {
            console.log('=== CLIENT: improveEmailWithAI called ===');
            console.log('Type:', type);
            
            const promptTextarea = document.getElementById(type + 'AIPrompt');
            const emailTextarea = document.getElementById(type + 'Body');
            
            console.log('Prompt textarea found:', !!promptTextarea);
            console.log('Email textarea found:', !!emailTextarea);
            
            if (!promptTextarea || !emailTextarea) {
                console.error('Required elements not found');
                showAlert('Error: Required fields not found', 'error');
                return;
            }
            
            const userPrompt = promptTextarea.value.trim();
            console.log('User prompt length:', userPrompt.length);
            console.log('User prompt:', userPrompt);
            
            if (!userPrompt) {
                console.warn('Empty prompt provided');
                showAlert('Please enter instructions for AI improvement', 'error');
                return;
            }
            
            // Show loading state
            const originalButtonText = event.target.textContent;
            event.target.disabled = true;
            event.target.textContent = '‚è≥ Improving...';
            showAlert('AI is improving your email template... This may take 10-30 seconds. ‚ú®', 'success');
            
            // Add a secondary message after 10 seconds
            const slowWarningTimeout = setTimeout(() => {
                showAlert('AI is still working... Please be patient. ‚è≥', 'success');
            }, 10000);
            
            try {
                const currentTemplate = emailTextarea.value || getWelcomeTemplate(type === 'waitlist');
                console.log('Current template length:', currentTemplate.length);
                console.log('Sending POST request to /api/improve-email-with-ai');
                
                const requestBody = {
                    emailTemplate: currentTemplate,
                    userPrompt: userPrompt,
                    emailType: type
                };
                console.log('Request body:', {
                    emailTemplateLength: requestBody.emailTemplate.length,
                    userPromptLength: requestBody.userPrompt.length,
                    emailType: requestBody.emailType
                });
                
                // Fetch with timeout
                const controller = new AbortController();
                const fetchTimeout = setTimeout(() => controller.abort(), 35000); // 35 second timeout
                
                const response = await fetch('/api/improve-email-with-ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                });
                
                clearTimeout(fetchTimeout);
                
                console.log('Response received:');
                console.log('- Status:', response.status);
                console.log('- Status Text:', response.statusText);
                console.log('- OK:', response.ok);
                console.log('- Headers:', Object.fromEntries(response.headers.entries()));
                
                let data;
                try {
                    const responseText = await response.text();
                    console.log('Raw response text:', responseText);
                    data = JSON.parse(responseText);
                    console.log('Parsed response data:', data);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    throw new Error('Invalid response from server');
                }
                
                if (data.success) {
                    console.log('‚úì AI improvement successful');
                    console.log('Improved template length:', data.improvedTemplate?.length || 0);
                    
                    if (!data.improvedTemplate) {
                        throw new Error('No improved template in response');
                    }
                    
                    // Directly update the email template
                    emailTextarea.value = data.improvedTemplate;
                    
                    // Clear the prompt and hide AI section
                    promptTextarea.value = '';
                    document.getElementById(type + 'AI').classList.remove('active');
                    
                    showAlert('‚úì Email improved by AI! Review and save your settings.', 'success');
                } else {
                    console.error('‚úó AI improvement failed');
                    console.error('Error from server:', data.error);
                    showAlert('AI improvement failed: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('=== CLIENT ERROR ===');
                console.error('Error type:', error.constructor.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                
                let errorMessage = 'Failed to improve email';
                if (error.name === 'AbortError') {
                    errorMessage = 'Request timed out. The AI took too long to respond. Please try again with a simpler prompt.';
                } else if (error.message.includes('fetch')) {
                    errorMessage = 'Network error. Please check your connection.';
                } else if (error.message.includes('timeout')) {
                    errorMessage = 'Request timed out. Please try again.';
                } else if (error.message) {
                    errorMessage += ': ' + error.message;
                }
                
                showAlert(errorMessage, 'error');
            } finally {
                // Clear the slow warning timeout
                clearTimeout(slowWarningTimeout);
                
                // Restore button state
                if (event && event.target) {
                    event.target.disabled = false;
                    event.target.textContent = originalButtonText;
                }
            }
        }
        
        // Close modal when clicking outside
        document.getElementById('emailPreviewModal').addEventListener('click', (e) => {
            if (e.target.id === 'emailPreviewModal') {
                closePreviewModal();
            }
        });
        
        document.getElementById('aiPreviewModal').addEventListener('click', (e) => {
            if (e.target.id === 'aiPreviewModal') {
                closeAIPreviewModal();
            }
        });
    </script>
</body>
</html>
